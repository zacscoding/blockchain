# 네트워크 구축  

![네트워크 예제](./pics/fabric_ca_network_example.png)  

## Index  

- <a href="#hostname">Hostname 설정</a>  
- <a href="#install_ca">fabric-ca 설치</a>
- <a href="#ca-admin-create">Fabric-CA 서버 실행 및 서버의 운영자 계정 생성</a>  
- <a href="#ca-server-admin-create-msp">Fabric-CA 서버 운영자 MSP 생성</a>  
- <a href="#organization_create">조직 생성 및 조직 운영자 MSP 생성</a>  

---  

<div id="hostname"></div>  

## Hostname 설정  

> vi /etc/hostname  

```
peer0
```  

> check  

```
hostname
```

> vi /etc/hosts  

```
127.0.0.1       localhost
127.0.1.1       ubuntu

# Hyperledger
192.168.5.11  peer0
192.168.5.12  peer1
192.168.5.21  peer2
192.168.5.22  peer3

192.168.5.31  orderer0
192.168.5.32  kafka-zookeeper

192.168.5.13 admin@org0
192.168.5.23 admin@org1
192.168.5.33 admin@ordererorg0
```

---  

<div id="install_ca"></div>  

## fabric-ca 설치  

> 소스 다운로드 및 컴파일

```
root@ubuntu:~/gopath# cd $GOPATH/src/github.com/hyperledger
root@ubuntu:~/gopath/src/github.com/hyperledger# git clone -b release-1.3 https://github.com/hyperledger/fabric-ca
Cloning into 'fabric-ca'...
root@ubuntu:~/gopath/src/github.com/hyperledger# cd fabric-ca
root@ubuntu:~/gopath/src/github.com/hyperledger# make fabric-ca-server
root@ubuntu:~/gopath/src/github.com/hyperledger# make fabric-ca-client
```   

> 환경변수 등록(/etc/profile)  

```
# hyperledger fabric-ca
export PATH=$PATH:$GOPATH/src/github.com/hyperledger/fabric-ca/bin
```  

```
root@ubuntu:~/gopath/src/github.com/hyperledger/fabric-ca# source /etc/profile
```  

---  

<div id="ca-admin-create"></div>  

## Fabric-CA 서버 실행 및 서버의 운영자 계정 생성  

> Fabric-ca 설정파일 저장 경로 설정(Fabric-ca 노드에서 실행)  

```
root@ubuntu:~# vi /etc/profile


export FABRIC_CA_SERVER_HOME=/root/testnet/
```  

> Fabric-CA 서버 구동  

```
root@ubuntu:~# fabric-ca-server start -b admin:adminpw --cfg.affiliations.allowremove --cfg.identities.allowremove -d
```  

- **-b admin:adminpw**  
; Fabric-CA 서버 운영자 id:password
- **--cfg.affiliations.allowremove**  
; Fabric-CA 서버 운영자에게 조직을 추가하고 삭제하는 권한 부여
- **--cfg.identities.allowremove**  
; Fabric-CA 서버 운영자에게 사용자 계정을 추가하고 삭제하는 권한 부여  
- **-d**  
; Fabric-CA 서버의 상세 로그 표시  

---  

<div id="ca-server-admin-create-msp"></div>

## Fabric-CA 서버 운영자 MSP 생성  
=> admin@ordererorg0 노드에게 Fabric-CA 서버 운영자 권한 부여  

> Fabric-CA 클라이언트 설정파일 저장 경로 설정(admin@ordererorg0에서 실행)  

```
#root@ubuntu:~/gopath/src/github.com/hyperledger/fabric-ca# vi /etc/profile

export FABRIC_CA_CLIENT_HOME=/root/testnet/

root@ubuntu:~/gopath/src/github.com/hyperledger/fabric-ca# source /etc/profile
```  

> Fabric-CA 운영자 권한 횐득(admin@ordererorg0에서 실행)  

```
root@ubuntu:~# fabric-ca-client enroll -u http://admin:adminpw@192.168.5.41:7054
2019/01/23 00:11:12 [INFO] Created a default configuration file at /root/testnet/fabric-ca-client-config.yaml
2019/01/23 00:11:12 [INFO] generating key: &{A:ecdsa S:256}
2019/01/23 00:11:12 [INFO] encoded CSR
2019/01/23 00:11:12 [INFO] Stored client certificate at /root/testnet/msp/signcerts/cert.pem
2019/01/23 00:11:12 [INFO] Stored root CA certificate at /root/testnet/msp/cacerts/192-168-5-41-7054.pem
2019/01/23 00:11:12 [INFO] Stored Issuer public key at /root/testnet/msp/IssuerPublicKey
2019/01/23 00:11:12 [INFO] Stored Issuer revocation public key at /root/testnet/msp/IssuerRevocationPublicKey
root@ubuntu:~/testnet# ll
total 64
drwxr-xr-x 3 root root  4096 Jan 23 00:11 ./
drwx------ 6 root root  4096 Jan 23 00:11 ../
-rw-r--r-- 1 root root 29395 Jan 15 00:21 core.yaml
-rwxr-xr-x 1 root root  6549 Jan 23 00:11 fabric-ca-client-config.yaml*
drwx------ 6 root root  4096 Jan 23 00:11 msp/
-rw-r--r-- 1 root root 11662 Jan 15 00:21 orderer.yaml
```  

- **-u**  
; MSP를 가져올 서버의 주소 (ID:PASSWORD@Fabric-CA서버주소)  
- **fabric-ca-client-config.yaml**  
; 클라이언트 설정이 담긴 파일 -> Fabric-CA 서버의 주소, MSP 경로, tls 설정 등  
- **msp**  
; Fabric-CA 서버 운영자 권한을 사용할 수 있는 MSP  

---  

<div id="organization_create"></div>

## 조직 생성 및 조직 운영자 MSP 생성  

> 기본 설정 조직 확인 및 제거(admin@ordererorg0 노드에서 실행)  

```
root@ubuntu:~/testnet# fabric-ca-client affiliation list
affiliation: .
   affiliation: org1
      affiliation: org1.department1
      affiliation: org1.department2
   affiliation: org2
      affiliation: org2.department1
root@ubuntu:~/testnet#
root@ubuntu:~/testnet#
root@ubuntu:~/testnet# fabric-ca-client affiliation remove --force org1
2019/01/23 00:24:59 [INFO] Configuration file location: /root/testnet/fabric-ca-client-config.yaml
Successfully removed affiliation: &{AffiliationInfo:{Name:org1 Affiliations:[{Name:org1.department1 Affiliations:[] Identities:[]} {Name:org1.department2 Affiliations:[] Identities:[]}] Identities:[]} CAName:}
root@ubuntu:~/testnet#
root@ubuntu:~/testnet# fabric-ca-client affiliation remove --force org2
2019/01/23 00:25:01 [INFO] Configuration file location: /root/testnet/fabric-ca-client-config.yaml
Successfully removed affiliation: &{AffiliationInfo:{Name:org2 Affiliations:[{Name:org2.department1 Affiliations:[] Identities:[]}] Identities:[]} CAName:}
```  

> 조직 추가 및 확인(admin@ordererorg0 노드에서 실행)  

```
root@ubuntu:~/testnet# fabric-ca-client affiliation add org0
root@ubuntu:~/testnet# fabric-ca-client affiliation add org1
root@ubuntu:~/testnet# fabric-ca-client affiliation add ordererorg0
root@ubuntu:~/testnet# fabric-ca-client affiliation list
affiliation: .
   affiliation: ordererorg0
   affiliation: org0
   affiliation: org1
```  

=> 각 조직의 운영자 노드에게 Fabric-CA 서버의 디지털 인증서를 다운로드  

> 디렉터리 생성 및 인증서 저장(admin@org0 노드에서 실행)  

```
root@ubuntu:~/testnet# mkdir -p /root/testnet/crypto-config/peerOrganizations/org0/msp
root@ubuntu:~/testnet# fabric-ca-client getcacert -u http://192.168.5.41:7054 -M /root/testnet/crypto-confmsp/
2019/01/23 00:29:37 [INFO] Configuration file location: /root/.fabric-ca-client/fabric-ca-client-config.ya
2019/01/23 00:29:37 [INFO] Stored root CA certificate at /root/testnet/crypto-config/peerOrganizations/org-7054.pem
2019/01/23 00:29:37 [INFO] Stored Issuer public key at /root/testnet/crypto-config/peerOrganizations/org0/
2019/01/23 00:29:37 [INFO] Stored Issuer revocation public key at /root/testnet/crypto-config/peerOrganizaationPublicKey
```


> 디렉터리 생성 및 인증서 저장(admin@org1 노드에서 실행)  

```
root@ubuntu:~# mkdir -p /root/testnet/crypto-config/peerOrganizations/org1/msp
root@ubuntu:~# fabric-ca-client getcacert -u http://192.168.5.41:7054 -M /root/testnet/crypto-config/peerO
2019/01/23 00:30:37 [INFO] Configuration file location: /root/.fabric-ca-client/fabric-ca-client-config.ya
2019/01/23 00:30:37 [INFO] Stored root CA certificate at /root/testnet/crypto-config/peerOrganizations/org-7054.pem
2019/01/23 00:30:37 [INFO] Stored Issuer public key at /root/testnet/crypto-config/peerOrganizations/org1/
2019/01/23 00:30:37 [INFO] Stored Issuer revocation public key at /root/testnet/crypto-config/peerOrganizaationPublicKey
```  

> 디렉터리 생성 및 인증서 저장(admin@ordererorg0 노드에서 실행)  

```
root@ubuntu:~/testnet# mkdir -p /root/testnet/crypto-config/ordererOrganizations/ordererorg0/msp
root@ubuntu:~/testnet# fabric-ca-client getcacert -u http://192.168.5.41:7054 -M /root/testnet/crypto-config/ordererOrganizations/ordererorg0/msp
2019/01/23 00:33:46 [INFO] Configuration file location: /root/testnet/fabric-ca-client-config.yaml
2019/01/23 00:33:46 [INFO] Stored root CA certificate at /root/testnet/crypto-config/ordererOrganizations/ordererorg0/msp/cacerts/192-168-5-41-7054.pem
2019/01/23 00:33:46 [INFO] Stored Issuer public key at /root/testnet/crypto-config/ordererOrganizations/ordererorg0/msp/IssuerPublicKey
2019/01/23 00:33:46 [INFO] Stored Issuer revocation public key at /root/testnet/crypto-config/ordererOrganizations/ordererorg0/msp/IssuerRevocationPublicKey
```  

> 각 인증서이름 ip-port.pem ca.crt로 변경  
(스크립트 재사용을 위해)  

```
/root/testnet/crypto-config/peerOrganizations/org0/msp/cacerts에 있는 파일 ca.cert로 변경
```  

> #### Fabric-CA 서버의 운영자 권한을 가진 admin@ordererorg0 노드에서 각 조직의 운영자 계정 등록  

> Admin@org0 생성

```
root@ubuntu:~# vi /root/testnet/fabric-ca-client-config.yaml (line 123~130)

id:
  # Admin@org0 이름의 ID로 org0 조직의 운영자 계정을 생성
  name: Admin@org0
  type: client
  affiliation: org0
  # 현재 등록하는 계정을 사용할 수 있는 횟수(fabric-ca enrolle 명령어)
  maxenrollments: 0

  attributes:
    # Admin@org0 계정으로 등록할 수 있는 노드의 종류
    - name: hf.Registrar.Roles
      value: client,orderer,peer,user
    - name: hf.Registrar.DelegateRoles
      value: client,orderer,peer,user
    - name: hf.Registrar.Attributes
      value: "*"
    # CRL을 생성할 수 있음   
    - name: hf.GenCRL
      value: true
    - name: hf.Revoker
      value: true
    - name: hf.AffiliationMgr
      value: true
    - name: hf.IntermediateCA
      value: true
    # 운영자 권한
    - name: role
      value: admin
      ecert: true
```  

```
root@ubuntu:~# fabric-ca-client register --id.secret=org@password
2019/01/23 20:53:32 [INFO] Configuration file location: /root/testnet/fabric-ca-client-config.yaml
Password: org@password
```  

> Admin@org1 생성

```
root@ubuntu:~# vi /root/testnet/fabric-ca-client-config.yaml (line 123~130)

id:  
  name: Admin@org1
  type: client
  affiliation: org1  
  maxenrollments: 0

  attributes:    
    - name: hf.Registrar.Roles
      value: client,orderer,peer,user
    - name: hf.Registrar.DelegateRoles
      value: client,orderer,peer,user
    - name: hf.Registrar.Attributes
      value: "*"    
    - name: hf.GenCRL
      value: true
    - name: hf.Revoker
      value: true
    - name: hf.AffiliationMgr
      value: true
    - name: hf.IntermediateCA
      value: true    
    - name: role
      value: admin
      ecert: true
```  

```
root@ubuntu:~# fabric-ca-client register --id.secret=org1@password
2019/01/23 20:56:45 [INFO] Configuration file location: /root/testnet/fabric-ca-client-config.yaml
Password: org1@password
```  

> Admin@ordererorg0 생성  

```
root@ubuntu:~# vi /root/testnet/fabric-ca-client-config.yaml (line 123~130)

id:  
  name: Admin@ordererorg0
  type: client
  affiliation: ordererorg0  
  maxenrollments: 0

  attributes:    
    - name: hf.Registrar.Roles
      value: client,orderer,peer,user
    - name: hf.Registrar.DelegateRoles
      value: client,orderer,peer,user
    - name: hf.Registrar.Attributes
      value: "*"    
    - name: hf.GenCRL
      value: true
    - name: hf.Revoker
      value: true
    - name: hf.AffiliationMgr
      value: true
    - name: hf.IntermediateCA
      value: true    
    - name: role
      value: admin
      ecert: true
```  

```
root@ubuntu:~# fabric-ca-client register --id.secret=ordererorg0@password
2019/01/23 21:00:41 [INFO] Configuration file location: /root/testnet/fabric-ca-client-config.yaml
Password: ordererorg0@password
```   

> #### 각 조직의 운영자 노드에 MSP 생성  

> org0 조직 운영자 MSP 생성(admin@org0 노드에서 실행)  

```
root@ubuntu:~# fabric-ca-client enroll -u http://Admin@org0:org@password@192.168.5.41:7054 -H /root/testnezations/org0/users/Admin@org0/
2019/01/23 21:06:51 [INFO] generating key: &{A:ecdsa S:256}
2019/01/23 21:06:51 [INFO] encoded CSR
2019/01/23 21:06:51 [INFO] Stored client certificate at /root/testnet/crypto-config/peerOrganizations/org0certs/cert.pem
2019/01/23 21:06:51 [INFO] Stored root CA certificate at /root/testnet/crypto-config/peerOrganizations/orgerts/192-168-5-41-7054.pem
2019/01/23 21:06:51 [INFO] Stored Issuer public key at /root/testnet/crypto-config/peerOrganizations/org0/rPublicKey
2019/01/23 21:06:51 [INFO] Stored Issuer revocation public key at /root/testnet/crypto-config/peerOrganiza0/msp/IssuerRevocationPublicKey
root@ubuntu:~#
root@ubuntu:~# mv /root/testnet/crypto-config/peerOrganizations/org0/users/Admin@org0/msp/cacerts/192-168-t/crypto-config/peerOrganizations/org0/users/Admin@org0/msp/cacerts/ca.crt
root@ubuntu:~#
root@ubuntu:~# mv /root/testnet/crypto-config/peerOrganizations/org0/users/Admin@org0/msp/keystore/d68b45053163c5f182f4c3058c5d3b1be2150e65ba8cd431070ebb2c284ed96e_sk /root/testnet/crypto-config/peerOrganizations/org0/users/Admin@org0/msp/keystore/server.key
```  


> org1 조직 운영자 MSP 생성(admin@org1 노드에서 실행)  

```
root@ubuntu:~# fabric-ca-client enroll -u http://Admin@org1:org1@password@192.168.5.41:7054 -H /root/testnezations/org0/users/Admin@org0/
2019/01/23 21:06:51 [INFO] generating key: &{A:ecdsa S:256}
2019/01/23 21:06:51 [INFO] encoded CSR
2019/01/23 21:06:51 [INFO] Stored client certificate at /root/testnet/crypto-config/peerOrganizations/org0certs/cert.pem
2019/01/23 21:06:51 [INFO] Stored root CA certificate at /root/testnet/crypto-config/peerOrganizations/orgerts/192-168-5-41-7054.pem
2019/01/23 21:06:51 [INFO] Stored Issuer public key at /root/testnet/crypto-config/peerOrganizations/org0/rPublicKey
2019/01/23 21:06:51 [INFO] Stored Issuer revocation public key at /root/testnet/crypto-config/peerOrganiza0/msp/IssuerRevocationPublicKey
root@ubuntu:~#
root@ubuntu:~# mv /root/testnet/crypto-config/peerOrganizations/org0/users/Admin@org0/msp/cacerts/192-168-t/crypto-config/peerOrganizations/org0/users/Admin@org0/msp/cacerts/ca.crt
root@ubuntu:~#
root@ubuntu:~# mv /root/testnet/crypto-config/peerOrganizations/org0/users/Admin@org0/msp/keystore/d68b45053163c5f182f4c3058c5d3b1be2150e65ba8cd431070ebb2c284ed96e_sk /root/testnet/crypto-config/peerOrganizations/org0/users/Admin@org0/msp/keystore/server.key
```  








<br /><br /><br /><br />
